# yaml-language-server: $schema=https://raw.githubusercontent.com/yannh/kubernetes-json-schema/refs/heads/master/v1.32.0/mutatingadmissionpolicybinding-admissionregistration-v1alpha1.json
apiVersion: admissionregistration.k8s.io/v1alpha1
kind: MutatingAdmissionPolicyBinding
metadata:
  name: dragonfly-operator-add-proxy
spec:
  policyName: dragonfly-operator-add-proxy
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/yannh/kubernetes-json-schema/refs/heads/master/v1.32.0/mutatingadmissionpolicy-admissionregistration-v1alpha1.json
apiVersion: admissionregistration.k8s.io/v1alpha1
kind: MutatingAdmissionPolicy
metadata:
  name: dragonfly-operator-add-proxy
spec:
  matchConstraints:
    resourceRules:
      - apiGroups: ["apps"]
        apiVersions: ["v1"]
        operations: ["CREATE", "UPDATE"]
        resources: ["deployments"]
  matchConditions:
    - name: check-deployment-name
      expression: >
        object.metadata.name == 'dragonfly-operator'
    - name: has-dragonfly-operator-labels
      expression: >
        object.metadata.labels["app.kubernetes.io/name"] == "dragonfly-operator"
    - name: manager-container-does-exist
      expression: >
        object.spec.template.spec.containers.exists(c, c.name == 'manager')
  failurePolicy: Fail
  reinvocationPolicy: IfNeeded
  mutations:
    - patchType: JSONPatch
      jsonPatch:
        expression: |
          [
            {
              "op": "add",
              "path": "/spec/template/spec/containers/[name=manager]/env/-",
              "value": {
                "name": "HTTP_PROXY",
                "value": "http://172.19.82.10:1080"
              }
            },
            {
              "op": "add",
              "path": "/spec/template/spec/containers/[name=manager]/env/-",
              "value": {
                "name": "HTTPS_PROXY",
                "value": "http://172.19.82.10:1080"
              }
            },
            {
              "op": "add",
              "path": "/spec/template/spec/containers/[name=manager]/env/-",
              "value": {
                "name": "NO_PROXY",
                "value": ".cluster.local.,.cluster.local,.svc,localhost,127.0.0.1,10.100.0.0/16"
              }
            }
          ]
