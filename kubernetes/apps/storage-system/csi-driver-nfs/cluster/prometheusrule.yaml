---
# yaml-language-server: $schema=https://kubernetes-schemas.noirprime.com/monitoring.coreos.com/prometheusrule_v1.json
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: nfs-rules
spec:
  groups:
    - name: nfs.rules
      rules:
        - alert: NFSVolumeUnhealthy
          expr: |
            kubelet_volume_stats_health_status{status="unhealthy"} == 1
            and on(persistentvolumeclaim, namespace)
            kube_persistentvolumeclaim_info{storageclass=~".*nfs.*"}
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "NFS volume unhealthy (PVC: {{ $labels.persistentvolumeclaim }})"
            description: |
              Volume: [{{ $labels.volume }}] at node [{{ $labels.node }}] unhealthy for 5 minutes.
              PVC: {{ $labels.namespace }}/{{ $labels.persistentvolumeclaim }}
              PV: {{ $labels.persistentvolume }}
              Pod: {{ $labels.pod }}
        - alert: NFSStorageOffline
          expr: |
            sum by (node, instance) (
            kubelet_volume_stats_health_status{status="unhealthy"}
            * on(volume) group_left(storage_provider)
            kube_persistentvolume_info{storage_provider="nfs.csi.k8s.io"}
            ) > 3
          for: 3m
          labels:
            severity: critical
          annotations:
            summary: "NFS storage offline (node: {{ $labels.node }})"
            description: |
              Node [{{ $labels.node }}] has 3+ NFS volume offline.
              Count: {{ $value }}
              Node: {{ $labels.instance }}
