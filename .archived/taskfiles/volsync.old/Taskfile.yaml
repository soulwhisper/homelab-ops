---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars:
  VOLSYNC_TASK_RESOURCES_DIR: "{{.ROOT_DIR}}/.taskfiles/volsync/resources"
  VOLSYNC_NS: "storage-system"

tasks:
  unlock:
    desc: Unlock a restic source repo from local machine [NS=default] [APP=required]
    preconditions:
      - which kubectl minijinja-cli stern
      - test -f {{.VOLSYNC_RESOURCES_DIR}}/unlock.yaml.j2
    requires:
      vars:
        - APP
    vars:
      NS: '{{.NS | default "default"}}'
      JOB: "volsync-unlock-{{ .APP }}"
    env:
      NS: "{{.NS}}"
      APP: "{{.APP}}"
    cmds:
      - minijinja-cli {{.VOLSYNC_RESOURCES_DIR}}/unlock.yaml.j2 | kubectl apply --server-side --filename -
      - until kubectl --namespace {{.NS}} get job/{{ .JOB }} &>/dev/null; do sleep 5; done
      - kubectl --namespace {{.NS}} wait job/{{ .JOB }} --for=condition=complete --timeout=5m
      - stern --namespace {{.NS}} job/{{ .JOB }} --no-follow
      - kubectl --namespace {{.NS}} delete job {{ .JOB }}
