{% if ENV.MODE == 'test' %}
  {% set subnet = '172.19.82' %}
{% else %}
  {% set subnet = '10.10.0' %}
{% endif %}
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/siderolabs/talos/refs/heads/release-1.10/website/content/v1.10/schemas/config.schema.json
version: v1alpha1
machine:
  type: controlplane
  token: op://DevOps/talos/machine_token
  ca:
    crt: op://DevOps/talos/machine_ca_crt
    key: op://DevOps/talos/machine_ca_key
  env:
    http_proxy: http://{{ subnet }}.10:1080
    https_proxy: http://{{ subnet }}.10:1080
    no_proxy: .noirprime.com,.homelab.internal,localhost,127.0.0.1,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16
  features:
    apidCheckExtKeyUsage: true
    diskQuotaSupport: true
    hostDNS:
      enabled: true
      forwardKubeDNSToHost: false
      resolveMemberNames: true
    kubePrism:
      enabled: true
      port: 7445
    kubernetesTalosAPIAccess:
      enabled: true
      allowedRoles:
        - os:admin
        - os:etcd:backup
      allowedKubernetesNamespaces:
        - gitops-system
    nodeAddressSortAlgorithm: v2
    rbac: true
    stableHostname: true
  files:
    - content: |-
        [plugins]
          [plugins."io.containerd.cri.v1.images"]
            discard_unpacked_layers = false
          [plugins."io.containerd.cri.v1.runtime"]
            device_ownership_from_security_context = true
          [plugins."io.containerd.grpc.v1.cri"]
            enable_unprivileged_ports = true
            enable_unprivileged_icmp = true
      permissions: 0o0
      path: /etc/cri/conf.d/20-customization.part
      op: create
  install:
    image: factory.talos.dev/metal-installer-secureboot/{{ ENV.TALOS_SCHEMATIC }}:{{ ENV.TALOS_VERSION }}
  kernel:
    modules:
      - name: thunderbolt
      - name: thunderbolt_net
  kubelet:
    image: ghcr.io/siderolabs/kubelet:{{ ENV.KUBERNETES_VERSION }}
    extraMounts:
      - destination: /var/local/openebs
        type: bind
        source: /var/local/openebs
        options:
          - rbind
          - rshared
          - rw
    defaultRuntimeSeccompProfileEnabled: true
    nodeIP:
      validSubnets:
        - {{ subnet }}.0/24
    disableManifestsDirectory: true
  network:
    disableSearchDomain: true
    extraHostEntries:
      - ip: {{ subnet }}.100
        aliases:
          - k8s.homelab.internal
  sysctls:
    fs.inotify.max_user_instances: "524288"
    fs.inotify.max_user_watches: "524288"
    net.core.rmem_max: "134217728"
    net.core.wmem_max: "134217728"
    net.ipv4.neigh.default.gc_thresh1: "32768"
    net.ipv4.neigh.default.gc_thresh2: "65536"
    net.ipv4.neigh.default.gc_thresh3: "131072"
    net.ipv4.tcp_rmem: 4096 87380 67108864
    net.ipv4.tcp_wmem: 4096 65536 67108864
    sunrpc.tcp_max_slot_table_entries: "1024"
    sunrpc.tcp_slot_table_entries: "128"
    user.max_user_namespaces: "11255"
  time:
    disabled: false
    servers:
        - {{ subnet }}.10
cluster:
  id: op://DevOps/talos/cluster_id
  secret: op://DevOps/talos/cluster_secret
  token: op://DevOps/talos/cluster_token
  secretboxEncryptionSecret: op://DevOps/talos/cluster_secretboxencryptionsecret
  ca:
    crt: op://DevOps/talos/cluster_ca_crt
    key: op://DevOps/talos/cluster_ca_key
  aggregatorCA:
    crt: op://DevOps/talos/cluster_aggregatorca_crt
    key: op://DevOps/talos/cluster_aggregatorca_key
  serviceAccount:
    key: op://DevOps/talos/cluster_serviceaccount_key
  allowSchedulingOnControlPlanes: true
  clusterName: main
  controlPlane:
    endpoint: https://k8s.homelab.internal:6443
  apiServer:
    image: registry.k8s.io/kube-apiserver:{{ ENV.KUBERNETES_VERSION }}
    certSANs:
      - k8s.homelab.internal
      - {{ subnet }}.100
      - 127.0.0.1 # KubePrism
    disablePodSecurityPolicy: true
  controllerManager:
    image: registry.k8s.io/kube-controller-manager:{{ ENV.KUBERNETES_VERSION }}
  coreDNS:
    disabled: true
  discovery:
    enabled: true
    registries:
      kubernetes:
        disabled: true
      service:
        endpoint: http://{{ subnet }}.10:9300
  etcd:
    ca:
      crt: op://DevOps/talos/cluster_etcd_ca_crt
      key: op://DevOps/talos/cluster_etcd_ca_key
    extraArgs:
      quota-backend-bytes: "8589934592"
      listen-metrics-urls: http://0.0.0.0:2381
    advertisedSubnets:
      - {{ subnet }}.0/24
  network:
    cni:
      name: none
    dnsDomain: cluster.local
    podSubnets:
      - 10.100.0.0/17
    serviceSubnets:
      - 10.100.128.0/17
  proxy:
    disabled: true
    image: registry.k8s.io/kube-proxy:{{ ENV.KUBERNETES_VERSION }}
  scheduler:
    image: registry.k8s.io/kube-scheduler:{{ ENV.KUBERNETES_VERSION }}
    config:
      apiVersion: kubescheduler.config.k8s.io/v1
      kind: KubeSchedulerConfiguration
      profiles:
        - pluginConfig:
            - args:
                defaultConstraints:
                  - maxSkew: 1
                    topologyKey: kubernetes.io/hostname
                    whenUnsatisfiable: ScheduleAnyway
                defaultingType: List
              name: PodTopologySpread
          plugins:
            score:
              disabled:
                - name: ImageLocality
          schedulerName: default-scheduler
    extraArgs:
      bind-address: 0.0.0.0
---
apiVersion: v1alpha1
kind: ExtensionServiceConfig
name: nut-client
configFiles:
  - content: |-
      MONITOR santak-box@{{ subnet }}.10 1 monuser monuser secondary
      SHUTDOWNCMD "/sbin/poweroff"
    mountPath: /usr/local/etc/nut/upsmon.conf
