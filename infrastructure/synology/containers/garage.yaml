---
# Bootstrap via ssh
# garage status
# garage layout assign -z main -c 1TB <node-id>
# garage layout apply --version 1
# garage bucket create postgres
# garage key import $access_key $secret_key -n postgres --yes
# garage bucket allow --read --write postgres --key postgres

configs:
  garage.toml:
    content: |
      metadata_dir = "/tmp/meta"
      data_dir = "/tmp/data"
      db_engine = "sqlite"
      metadata_auto_snapshot_interval = "6h"
      replication_factor = 1
      rpc_bind_addr = "[::]:9001"
      rpc_public_addr = "127.0.0.1:9001"
      rpc_secret = "adbc7a0edaa7e35de527d45762002ee6efa57c07cd870b3dc454c242e4ee99a3"
      [s3_api]
      s3_region = "us-east-1"
      api_bind_addr = "[::]:9000"
      [admin]
      api_bind_addr = "[::]:9002"
      admin_token = "YOUR_ADMIN_TOKEN_HERE"
      metrics_token = "YOUR_METRICS_TOKEN_HERE"

services:
  garage:
    image: "dxflrs/garage:v2.1.0"
    container_name: "garage"
    restart: "unless-stopped"
    ports:
      - "9000:9000/tcp"
    configs:
      - source: "garage.toml"
        target: "/etc/garage.toml"
    volumes:
      - "/volume3/docker/garage/data:/tmp/data"
      - "/volume3/docker/garage/meta:/tmp/meta"

  # garage-webui:
  #   image: "khairul169/garage-webui:latest"
  #   container_name: "garage-webui"
  #   restart: "unless-stopped"
  #   ports:
  #     - "9201:3909/tcp"
  #   configs:
  #     - source: "garage.toml"
  #       target: "/etc/garage.toml"
  #   environment:
  #     - "API_BASE_URL=http://garage:9002"
  #     - "S3_ENDPOINT_URL=http://garage:9000"
