set quiet := true
set shell := ['bash', '-euo', 'pipefail', '-c']

BUCKETS := 'postgres volsync'
AWS_ENDPOINT_URL := env_var_or_default('AWS_ENDPOINT_URL', 'http://localhost:9000')

[private]
default:
  @just --list

[doc('Init Archlinux workstation')]
workstation:
  @echo "Install pacman packages"
  sudo pacman -Syuq --needed --noconfirm --noprogressbar $(cat Archfile | xargs)
  @echo "Install yay packages"
  yay -Syuq --needed --noconfirm --noprogressbar $(cat Yayfile | xargs)
  @echo "Install krew packages"
  fish_add_path $HOME/.krew/bin
  kubectl krew index add default https://github.com/kubernetes-sigs/krew-index.git
  kubectl krew index add netshoot https://github.com/nilic/kubectl-netshoot.git
  kubectl krew install $(cat Krewfile | xargs)
  go install github.com/mirceanton/kubectl-switch/v2@latest
  fish_add_path $HOME/go/bin
  @echo "Import configs"
  [ -f .config.zip ] && unzip -oq .config.zip -d "$HOME"
  @echo "Set fish aliases"
  fish -i -c "alias --save k=kubectl"
  fish -i -c "alias --save kc='kubectl switch context'"
  fish -i -c "alias --save kns='kubectl switch ns'"
  fish -i -c "alias --save ks=kubescape"
  fish -i -c "alias --save kubectl='kubecolor --kubecolor-theme=protanopia-dark'"
  fish -i -c "alias --save watch='viddy --disable_auto_save --differences --interval 2 --shell fish'"
  fish -i -c "alias --save kyaml='kubectl $argv -o yaml | kubectl neat'"
  fish -i -c "alias --save flux-local='uvx flux-local'"
  @echo "Workstation setup complete"

[doc('Init/Reset Garage'), no-exit-message]
garage mode:
    #!/usr/bin/env bash
    set -euo pipefail
    function get_op_secret() {
        local item="$1"
        local field="$2"
        local result=""
        local count=0
        local retries=5
        while [[ $count -lt $retries ]]; do
            if result=$(op item get "$item" --fields "$field" --reveal 2>/dev/null); then
                if [[ -n "$result" ]]; then
                    echo "$result"
                    return 0
                fi
            fi
            ((count++))
            echo "‚ö†Ô∏è [Attempt $count/$retries] Failed to fetch $field from $item. Retrying in 2s..." >&2
            sleep 2
        done
        echo "‚ùå Critical: Failed to retrieve $field after $retries attempts." >&2
        return 1
    }
    for BUCKET in {{BUCKETS}}; do
        if [ "{{mode}}" = "init" ]; then
            echo "üîê Fetching credentials for ${BUCKET}..."
            access_key=$(get_op_secret "garage" "${BUCKET}_access_key")
            secret_key=$(get_op_secret "garage" "${BUCKET}_secret_key")
            : "${access_key:?Access key is empty}"
            : "${secret_key:?Secret key is empty}"
            echo "üöÄ Initializing bucket: ${BUCKET}"
            garage bucket create "${BUCKET}" || true
            garage key import "$access_key" "$secret_key" -n "${BUCKET}" --yes
            garage bucket allow --read --write "${BUCKET}" --key "${BUCKET}"
            echo "‚úÖ Created bucket: ${BUCKET}"
        elif [ "{{mode}}" = "reset" ]; then
            garage bucket delete "${BUCKET}" || echo "‚ö†Ô∏è Bucket ${BUCKET} not found or already deleted"
            echo "üóëÔ∏è Deleted bucket: ${BUCKET}"
        else
            echo "‚ùå Unknown mode: {{mode}}"
            exit 1
        fi
    done

[doc('Init/Reset Versity S3 Gateway'), no-exit-message]
versity mode:
    #!/usr/bin/env bash
    set -euo pipefail
    function get_op_secret() {
        local item="$1"
        local field="$2"
        local result=""
        local count=0
        local retries=5
        while [[ $count -lt $retries ]]; do
            if result=$(op item get "$item" --fields "$field" --reveal 2>/dev/null); then
                if [[ -n "$result" ]]; then
                    echo "$result"
                    return 0
                fi
            fi
            ((count++))
            echo "‚ö†Ô∏è [Attempt $count/$retries] Failed to fetch $field. Retrying..." >&2
            sleep 2
        done
        return 1
    }
    echo "üîê Fetching Admin Credentials..."
    AWS_ACCESS_KEY_ID=$(get_op_secret "app_user" "admin_user")
    AWS_SECRET_ACCESS_KEY=$(get_op_secret "app_user" "admin_pass")
    : "${AWS_ACCESS_KEY_ID:?AWS Access Key ID is missing}"
    : "${AWS_SECRET_ACCESS_KEY:?AWS Secret Key is missing}"
    export AWS_ACCESS_KEY_ID
    export AWS_SECRET_ACCESS_KEY
    for BUCKET in {{BUCKETS}}; do
        if [ "{{mode}}" = "init" ]; then
            if aws --endpoint-url "{{AWS_ENDPOINT_URL}}" s3api head-bucket --bucket "${BUCKET}" 2>/dev/null; then
                 echo "‚ÑπÔ∏è Bucket ${BUCKET} already exists. Skipping."
            else
                 echo "üöÄ Creating bucket: ${BUCKET}"
                 aws --endpoint-url "{{AWS_ENDPOINT_URL}}" s3api create-bucket --bucket "${BUCKET}"
                 echo "‚úÖ Created bucket: ${BUCKET}"
            fi
        elif [ "{{mode}}" = "reset" ]; then
            echo "üóëÔ∏è Deleting bucket: ${BUCKET}"
            aws --endpoint-url "{{AWS_ENDPOINT_URL}}" s3api delete-bucket --bucket "${BUCKET}" || echo "‚ö†Ô∏è Failed to delete or not found"
        else
            echo "‚ùå Unknown mode: {{mode}}"
            exit 1
        fi
    done
